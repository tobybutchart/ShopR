var supported="share"in navigator,btnShare=document.getElementById("btn-share-peer-id");
supported?btnShare.addEventListener("click",function(a){var b=document.getElementById("lbl-peer-id");"---"==b.innerHTML?showMsg("warning","No connection ID has been generated"):(console.log(a),a.preventDefault(),a={title:"ShopR List Share Request",text:"A ShopR share request has been sent: "+b.innerHTML,url:document.querySelector("link[rel=canonical]")?document.querySelector("link[rel=canonical]").href:document.location.href},navigator.share(a).then(function(a){console.log("navigator.share succeeded.",
a)})["catch"](function(a){console.error("navigator.share failed",a)}))}):btnShare.addEventListener("click",function(a){var b=document.getElementById("lbl-peer-id");"---"==b.innerHTML?showMsg("warning","No connection ID has been generated"):(console.log(a),a.preventDefault(),window.prompt("Your browser does not support Web Share API.\nHighlight the below and ctrl + c, or long click if on mobile and select share",b.innerHTML))});
var peer=null,lastPeerId=null,peerId=null,connected=!1,conn=null,userClosedConn=!1;function toggleReceiver(){connected?(userClosedConn=!0,peer.disconnect()):(userClosedConn=!1,initReceiver())}
function initReceiver(){var a=document.getElementById("lbl-peer-id"),b=document.getElementById("btn-generate-peer-id");peer=new Peer(null,{debug:2});peer.on("open",function(d){null===peer.id?(console.log("Received null id from peer open"),peer.id=lastPeerId):lastPeerId=peer.id;console.log("ID: "+peer.id);a.innerHTML=peer.id;b.style.color=MSG_SUCCESS_COLOUR;connected=!0;console.log("Awaiting connection...")});peer.on("connection",function(a){if(conn&&conn.open)a.on("open",function(){a.send("Already connected to another client");
setTimeout(function(){a.close()},500)});else conn=a,console.log("Connected to: "+conn.peer),conn.on("data",function(a){console.log("Data recieved",a);"{"!=a.substring(0,1)||"}"!=a.slice(-1)?(showMsg("error","An unknown list has been received"),console.log(a)):(a=JSON.parse(a),addAndDisplayList(a))}),conn.on("close",function(){console.log("Connection closed");conn=null})});peer.on("disconnected",function(){console.log("Connection disconnected. Please reconnect");peer.id=lastPeerId;peer._lastServerId=
lastPeerId;userClosedConn||peer.reconnect();var a=document.getElementById("lbl-peer-id"),b=document.getElementById("btn-generate-peer-id");a.innerHTML="---";b.style.color=MSG_ERROR_COLOUR;connected=!1});peer.on("close",function(){conn=null;console.log("Connection closed")});peer.on("error",function(a){console.log(a);showMsg("error","An error has occurred:<br>"+a)})}
function initSender(){peer=new Peer(null,{debug:2});peer.on("open",function(a){null===peer.id?(console.log("Received null id from peer open"),peer.id=lastPeerId):lastPeerId=peer.id;console.log("ID: "+peer.id);document.getElementById("btn-modal-connect").style.display="none";document.getElementById("btn-modal-send").style.display="inline-block"});peer.on("connection",function(a){a.on("open",function(){a.send("Sender does not accept incoming connections");setTimeout(function(){a.close()},500)})});peer.on("disconnected",
function(){console.log("Connection disconnected");peer.id=lastPeerId;peer._lastServerId=lastPeerId;userClosedConn||peer.reconnect()});peer.on("close",function(){conn=null;console.log("Connection closed")});peer.on("error",function(a){console.log(a);showMsg("error","An error has occurred:<br>"+a)})}
function joinPeer(a){conn&&conn.close();conn=peer.connect(a,{reliable:!0});conn.on("open",function(){console.log("Connected to: "+conn.peer);var a=document.getElementById("lbl-send-id"),d=document.getElementById("lbl-send-message"),c=document.getElementById("btn-modal-send").dataset.id,c=getListByProp("uuid",c);c.message=d.value;conn.send(JSON.stringify(c));console.log("Sent: "+JSON.stringify(c));a.value="";d.value="";userClosedConn=!0;hideModal("send-modal");showMsg("info","List sent")});conn.on("data",
function(a){console.log("Data received: ",a)});conn.on("close",function(){console.log("Connection closed")})}function sendList(){var a=document.getElementById("lbl-send-id");document.getElementById("lbl-send-message");document.getElementById("btn-modal-send");""==a.value?(showMsg("error","A valid connection ID must be given"),document.getElementById("btn-modal-connect").style.display="inline-block",document.getElementById("btn-modal-send").style.display="none"):joinPeer(a.value)};
